name: MPP Coding Agent Integration Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'mpp-core/**'
      - 'mpp-ui/**'
      - 'integration-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'mpp-core/**'
      - 'mpp-ui/**'
  schedule:
    # Run integration tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_category:
        description: 'Test category to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - simple
          - business
          - video
          - jwt
          - upgrade
          - graphql

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    strategy:
      matrix:
        node-version: [20.x, 21.x]
        test-category: 
          - ${{ github.event.inputs.test_category || 'all' }}
      fail-fast: false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: mpp-ui/package-lock.json
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Install mpp-ui dependencies
      working-directory: mpp-ui
      run: npm ci
    
    - name: Build mpp-core
      run: ./gradlew :mpp-core:assembleJsPackage
    
    - name: Build mpp-ui
      working-directory: mpp-ui
      run: npm run build:ts
    
    - name: Create test results directory
      run: mkdir -p test-results
    
    - name: Run integration tests
      working-directory: mpp-ui
      run: |
        if [ "${{ matrix.test-category }}" = "all" ]; then
          npm run test:integration
        elif [ "${{ matrix.test-category }}" = "business" ]; then
          npm run test:business
        else
          npm run test:integration:${{ matrix.test-category }}
        fi
      env:
        CI: true
        NODE_ENV: test
        QUIET: true
        # Increase timeout for CI environment
        TEST_TIMEOUT: 900000
      timeout-minutes: 30
    
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.node-version }}-${{ matrix.test-category }}
        path: |
          mpp-ui/coverage/
          test-results/
        retention-days: 7
    
    - name: Upload test projects (on failure)
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: failed-test-projects-${{ matrix.node-version }}-${{ matrix.test-category }}
        path: /tmp/autodev-test-*
        retention-days: 3
    
    - name: Comment PR with test results
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request' && always()
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Try to read test results and create a summary comment
          let comment = `## ðŸ§ª Integration Test Results\n\n`;
          comment += `**Node.js Version:** ${{ matrix.node-version }}\n`;
          comment += `**Test Category:** ${{ matrix.test-category }}\n`;
          comment += `**Status:** ${{ job.status }}\n\n`;
          
          if ('${{ job.status }}' === 'success') {
            comment += `âœ… All integration tests passed successfully!\n\n`;
            comment += `The CodingAgent demonstrates robust performance across all tested scenarios.`;
          } else {
            comment += `âŒ Some integration tests failed.\n\n`;
            comment += `Please check the test logs and artifacts for detailed information.`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  test-summary:
    runs-on: ubuntu-latest
    needs: integration-tests
    if: always()
    
    steps:
    - name: Generate test summary
      run: |
        echo "# ðŸ§ª CodingAgent Integration Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.integration-tests.result }}" = "success" ]; then
          echo "âœ… **All integration tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The CodingAgent demonstrates robust performance across all tested scenarios:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Simple robustness tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Business scenario implementations" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Error recovery mechanisms" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code quality standards" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Some integration tests failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the test logs and artifacts for detailed information." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Common issues to check:" >> $GITHUB_STEP_SUMMARY
          echo "- System resource constraints" >> $GITHUB_STEP_SUMMARY
          echo "- Network connectivity issues" >> $GITHUB_STEP_SUMMARY
          echo "- Environment configuration problems" >> $GITHUB_STEP_SUMMARY
          echo "- CodingAgent system prompt effectiveness" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Categories" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Category | Description | Complexity |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------------|------------|" >> $GITHUB_STEP_SUMMARY
        echo "| Simple | Basic tool usage validation | Low |" >> $GITHUB_STEP_SUMMARY
        echo "| Video Support | BlogPost entity enhancement | Medium |" >> $GITHUB_STEP_SUMMARY
        echo "| JWT Auth | Security implementation | High |" >> $GITHUB_STEP_SUMMARY
        echo "| Spring Upgrade | Version upgrade with error handling | Very High |" >> $GITHUB_STEP_SUMMARY
        echo "| GraphQL API | Modern API implementation | High |" >> $GITHUB_STEP_SUMMARY
