name: MPP Coding Agent Integration Tests v2

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'mpp-core/**'
      - 'mpp-ui/**'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'mpp-core/**'
      - 'mpp-ui/**'
  schedule:
    # Run integration tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_category:
        description: 'Test category to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - simple
          - business
          - errors
          - performance
          - custom
      pass_threshold:
        description: 'Pass rate threshold (0-100%)'
        required: false
        default: '80'
        type: string
      keep_test_projects:
        description: 'Keep test projects for debugging'
        required: false
        default: false
        type: boolean

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # å¢žåŠ è¶…æ—¶æ—¶é—´ä»¥é€‚åº”æ–°çš„æµ‹è¯•æ¡†æž¶

    strategy:
      matrix:
        node-version: [21.x]  # ç®€åŒ–ä¸ºå•ä¸€ç‰ˆæœ¬ä»¥å‡å°‘ CI æ—¶é—´
        test-category:
          - ${{ github.event.inputs.test_category || 'all' }}
      fail-fast: false

    env:
      # é…ç½® DeepSeek API
      DEEPSEEK_TOKEN: ${{ secrets.DEEPSEEK_TOKEN }}
      # æµ‹è¯•æ¡†æž¶é…ç½®
      CI: true
      NODE_ENV: test
      DEBUG: false
      KEEP_TEST_PROJECTS: ${{ github.event.inputs.keep_test_projects || 'false' }}
      PASS_THRESHOLD: ${{ github.event.inputs.pass_threshold || '80' }}
      # å¢žåŠ è¶…æ—¶æ—¶é—´
      TEST_TIMEOUT: 1200000  # 20åˆ†é’Ÿ
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: Cache npm dependencies
      uses: actions/cache@v3
      with:
        path: mpp-ui/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('mpp-ui/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Install mpp-ui dependencies
      working-directory: mpp-ui
      run: npm ci
    
    - name: Build mpp-core
      run: ./gradlew :mpp-core:assembleJsPackage
    
    - name: Build mpp-ui
      working-directory: mpp-ui
      run: npm run build:ts

    - name: Create test results directory
      run: mkdir -p test-results

    - name: Setup AutoDev config for CI
      run: |
        mkdir -p ~/.autodev
        cat > ~/.autodev/config.yaml << EOF
        active: ci-deepseek
        configs:
          - name: ci-deepseek
            provider: deepseek
            apiKey: ${{ secrets.DEEPSEEK_TOKEN }}
            model: deepseek-chat
        EOF
        echo "âœ… AutoDev config created for CI environment"

    - name: Validate test framework
      working-directory: mpp-ui
      run: npm run test:framework
    
    - name: Run integration tests v2
      working-directory: mpp-ui
      run: |
        echo "ðŸš€ Running CodingAgent Integration Tests v2"
        echo "Category: ${{ matrix.test-category }}"
        echo "Pass Threshold: ${PASS_THRESHOLD}%"
        echo "Keep Test Projects: ${KEEP_TEST_PROJECTS}"
        echo ""

        # è¿è¡Œå¯¹åº”çš„æµ‹è¯•ç±»åˆ«
        if [ "${{ matrix.test-category }}" = "all" ]; then
          echo "Running all integration tests v2..."
          npm run test:integration-v2
        elif [ "${{ matrix.test-category }}" = "simple" ]; then
          echo "Running simple robustness tests..."
          npm run test:integration-v2:simple
        elif [ "${{ matrix.test-category }}" = "business" ]; then
          echo "Running business scenario tests..."
          npm run test:integration-v2:business
        elif [ "${{ matrix.test-category }}" = "errors" ]; then
          echo "Running error recovery tests..."
          npm run test:integration-v2:errors
        elif [ "${{ matrix.test-category }}" = "performance" ]; then
          echo "Running performance tests..."
          npm run test:integration-v2:performance
        elif [ "${{ matrix.test-category }}" = "custom" ]; then
          echo "Running custom scenario tests..."
          npm run test:integration-v2:custom
        else
          echo "Unknown test category: ${{ matrix.test-category }}"
          exit 1
        fi
      timeout-minutes: 45

    - name: Analyze test results and check threshold
      if: always()
      working-directory: mpp-ui
      env:
        TEST_CATEGORY: ${{ matrix.test-category }}
      run: |
        echo "ðŸŽ¯ åˆ†æžæµ‹è¯•ç»“æžœå¹¶æ£€æŸ¥é˜ˆå€¼..."

        # è¿è¡Œæµ‹è¯•ç»“æžœåˆ†æžè„šæœ¬
        node scripts/analyze-test-results.cjs

        # è„šæœ¬ä¼šæ ¹æ®é˜ˆå€¼æ£€æŸ¥ç»“æžœè®¾ç½®é€‚å½“çš„é€€å‡ºç 
        # å¦‚æžœé€šè¿‡çŽ‡ä½ŽäºŽé˜ˆå€¼ï¼Œè„šæœ¬ä¼šä»¥éžé›¶é€€å‡ºç é€€å‡º

    - name: Generate detailed test report
      if: always()
      working-directory: mpp-ui
      run: |
        echo "ðŸ“Š Generating detailed test report..."

        # åˆ›å»ºæµ‹è¯•æŠ¥å‘Šç›®å½•
        mkdir -p test-results/reports

        # ç”Ÿæˆæµ‹è¯•æ‘˜è¦
        echo "## ðŸ¤– CodingAgent Integration Tests v2 Report" > test-results/reports/summary.md
        echo "" >> test-results/reports/summary.md
        echo "- **Test Category**: ${{ matrix.test-category }}" >> test-results/reports/summary.md
        echo "- **Node Version**: ${{ matrix.node-version }}" >> test-results/reports/summary.md
        echo "- **Timestamp**: $(date)" >> test-results/reports/summary.md
        echo "- **Pass Threshold**: ${PASS_THRESHOLD}%" >> test-results/reports/summary.md
        echo "- **Status**: ${{ job.status }}" >> test-results/reports/summary.md
        echo "" >> test-results/reports/summary.md

        # å¦‚æžœæœ‰æµ‹è¯•ç»“æžœæ–‡ä»¶ï¼Œæ·»åŠ è¯¦ç»†ä¿¡æ¯
        if [ -d "test-results" ] && [ "$(find test-results -name '*.json' -o -name '*.xml' | head -1)" ]; then
          echo "### ðŸ“ˆ Test Results Found" >> test-results/reports/summary.md
          echo "Detailed test results are available in the artifacts." >> test-results/reports/summary.md
        else
          echo "### âš ï¸ No detailed test results found" >> test-results/reports/summary.md
        fi

        echo "Test report generated successfully"

    - name: Generate GitHub Actions summary
      if: always()
      env:
        TEST_CATEGORY: ${{ matrix.test-category }}
        NODE_VERSION: ${{ matrix.node-version }}
        JOB_STATUS: ${{ job.status }}
      run: |
        echo "ðŸ“Š ç”Ÿæˆ GitHub Actions æ‘˜è¦..."
        node .github/scripts/generate-test-summary.cjs

    - name: Upload test results and reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-v2-${{ matrix.node-version }}-${{ matrix.test-category }}
        path: |
          mpp-ui/test-results/
          mpp-ui/coverage/
        retention-days: 14
    
    - name: Upload test projects (for debugging)
      uses: actions/upload-artifact@v4
      if: failure() || env.KEEP_TEST_PROJECTS == 'true'
      with:
        name: test-projects-${{ matrix.node-version }}-${{ matrix.test-category }}
        path: |
          /tmp/agent-test-*
          /tmp/autodev-test-*
        retention-days: 7
    
    - name: Comment PR with test results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request' && always()
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // åˆ›å»ºè¯¦ç»†çš„æµ‹è¯•ç»“æžœè¯„è®º
          let comment = `## ðŸ¤– CodingAgent Integration Tests v2 Results\n\n`;
          comment += `### ðŸ“Š Test Configuration\n`;
          comment += `- **Node.js Version:** ${{ matrix.node-version }}\n`;
          comment += `- **Test Category:** ${{ matrix.test-category }}\n`;
          comment += `- **Pass Threshold:** ${{ env.PASS_THRESHOLD }}%\n`;
          comment += `- **Status:** ${{ job.status }}\n`;
          comment += `- **Timestamp:** ${new Date().toISOString()}\n\n`;

          // è¯»å–æµ‹è¯•æŠ¥å‘Šæ‘˜è¦
          try {
            const summaryPath = 'mpp-ui/test-results/reports/summary.md';
            if (fs.existsSync(summaryPath)) {
              const summary = fs.readFileSync(summaryPath, 'utf8');
              comment += `### ðŸ“ˆ Test Summary\n\n${summary}\n\n`;
            }
          } catch (error) {
            console.log('Could not read test summary:', error.message);
          }

          if ('${{ job.status }}' === 'success') {
            comment += `### âœ… Test Results\n\n`;
            comment += `ðŸŽ‰ **All integration tests passed successfully!**\n\n`;
            comment += `The CodingAgent demonstrates robust performance with:\n`;
            comment += `- âœ… **Prompt Effectiveness**: System prompts correctly guide agent behavior\n`;
            comment += `- âœ… **Tool Usage**: Accurate and efficient tool selection and usage\n`;
            comment += `- âœ… **Code Quality**: Generated code meets quality standards\n`;
            comment += `- âœ… **Task Completion**: All required functionality implemented\n\n`;
            comment += `### ðŸ“Š Framework Features Validated\n`;
            comment += `- ðŸŽ¯ **Multi-dimensional Analysis**: Prompt effects, tool calls, code quality\n`;
            comment += `- ðŸ“ˆ **Standardized Scoring**: Consistent evaluation metrics\n`;
            comment += `- ðŸ”§ **Detailed Reporting**: Comprehensive test insights\n`;
          } else {
            comment += `### âŒ Test Results\n\n`;
            comment += `âš ï¸ **Some integration tests failed or encountered issues.**\n\n`;
            comment += `**Next Steps:**\n`;
            comment += `1. ðŸ“‹ Check the detailed test logs in the Actions tab\n`;
            comment += `2. ðŸ“ Download test artifacts for detailed analysis\n`;
            comment += `3. ðŸ” Review specific test failures and error messages\n`;
            comment += `4. ðŸ› ï¸ Use the new test framework's detailed reports for debugging\n\n`;
            comment += `**Available Artifacts:**\n`;
            comment += `- \`test-results-v2-${{ matrix.node-version }}-${{ matrix.test-category }}\`: Detailed test results and reports\n`;
            if ('${{ env.KEEP_TEST_PROJECTS }}' === 'true') {
              comment += `- \`test-projects-${{ matrix.node-version }}-${{ matrix.test-category }}\`: Test project files for debugging\n`;
            }
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  test-summary:
    runs-on: ubuntu-latest
    needs: integration-tests
    if: always()
    
    steps:
    - name: Generate test summary
      run: |
        echo "# ðŸ§ª CodingAgent Integration Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.integration-tests.result }}" = "success" ]; then
          echo "âœ… **All integration tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The CodingAgent demonstrates robust performance across all tested scenarios:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Simple robustness tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Business scenario implementations" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Error recovery mechanisms" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code quality standards" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Some integration tests failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the test logs and artifacts for detailed information." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Common issues to check:" >> $GITHUB_STEP_SUMMARY
          echo "- System resource constraints" >> $GITHUB_STEP_SUMMARY
          echo "- Network connectivity issues" >> $GITHUB_STEP_SUMMARY
          echo "- Environment configuration problems" >> $GITHUB_STEP_SUMMARY
          echo "- CodingAgent system prompt effectiveness" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Categories" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Category | Description | Complexity |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------------|------------|" >> $GITHUB_STEP_SUMMARY
        echo "| Simple | Basic tool usage validation | Low |" >> $GITHUB_STEP_SUMMARY
        echo "| Video Support | BlogPost entity enhancement | Medium |" >> $GITHUB_STEP_SUMMARY
        echo "| JWT Auth | Security implementation | High |" >> $GITHUB_STEP_SUMMARY
        echo "| Spring Upgrade | Version upgrade with error handling | Very High |" >> $GITHUB_STEP_SUMMARY
        echo "| GraphQL API | Modern API implementation | High |" >> $GITHUB_STEP_SUMMARY
